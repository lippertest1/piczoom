/*! piczoom 2015-07-19 */
(function(){"use strict";var a=function(a){var b=function(b,c){this.el=a(b),this.zoomFactor=1,this.lastScale=1,this.offset={x:0,y:0},this.options=a.extend({},this.defaults,c),this.setupMarkup(),this.bindEvents(),this.update(),this.enable()},c=function(a,b){return a+b},d=function(a,b){return a>b-.01&&b+.01>a};b.prototype={defaults:{tapZoomFactor:2,zoomOutFactor:1.3,animationDuration:300,animationInterval:5,maxZoom:4,minZoom:.5,lockDragAxis:!1,use2d:!0,zoomStartEventName:"pz_zoomstart",zoomEndEventName:"pz_zoomend",dragStartEventName:"pz_dragstart",dragEndEventName:"pz_dragend",doubleTapEventName:"pz_doubletap"},handleDragStart:function(a){this.el.trigger(this.options.dragStartEventName),this.stopAnimation(),this.lastDragPosition=!1,this.hasInteraction=!0,this.handleDrag(a)},handleDrag:function(a){if(this.zoomFactor>1){var b=this.getTouches(a)[0];this.drag(b,this.lastDragPosition),this.offset=this.sanitizeOffset(this.offset),this.lastDragPosition=b}},handleDragEnd:function(){this.el.trigger(this.options.dragEndEventName),this.end()},handleZoomStart:function(a){this.el.trigger(this.options.zoomStartEventName),this.stopAnimation(),this.lastScale=1,this.nthZoom=0,this.lastZoomCenter=!1,this.hasInteraction=!0,this.startAngle=0},handleFirstZoom:function(a){this.startAngle=this.getRotateAngle(this.getTouches(a))},handleZoom:function(a,b){var c=this.getTouchCenter(this.getTouches(a)),d=b/this.lastScale;this.lastScale=b,this.nthZoom+=1,this.nthZoom>3&&(this.scale(d,c),this.drag(c,this.lastZoomCenter),this.rotate(c,this.lastZoomCenter),this.rotateAngle=this.getRotateAngle(this.getTouches(a))-this.startAngle,this.rotateAngle+=this.lastAngle||0),this.lastZoomCenter=c},handleZoomEnd:function(){this.el.trigger(this.options.zoomEndEventName),this.end()},handleDoubleTap:function(a){var b=this.getTouches(a)[0],c=this.zoomFactor>1?1:this.options.tapZoomFactor,d=this.zoomFactor,e=function(a){this.scaleTo(d+a*(c-d),b)}.bind(this);this.hasInteraction||(d>c&&(b=this.getCurrentZoomCenter()),this.animate(this.options.animationDuration,this.options.animationInterval,e,this.swing),this.el.trigger(this.options.doubleTapEventName))},sanitizeOffset:function(a){var b=(this.zoomFactor-1)*this.getContainerX(),c=(this.zoomFactor-1)*this.getContainerY(),d=Math.max(b,0),e=Math.max(c,0),f=Math.min(b,0),g=Math.min(c,0);return{x:Math.min(Math.max(a.x,f),d),y:Math.min(Math.max(a.y,g),e)}},scaleTo:function(a,b){this.scale(a/this.zoomFactor,b)},scale:function(a,b){a=this.scaleZoomFactor(a),this.addOffset({x:(a-1)*(b.x+this.offset.x),y:(a-1)*(b.y+this.offset.y)})},scaleZoomFactor:function(a){var b=this.zoomFactor;return this.zoomFactor*=a,this.zoomFactor=Math.min(this.options.maxZoom,Math.max(this.zoomFactor,this.options.minZoom)),this.zoomFactor/b},drag:function(a,b){b&&(this.options.lockDragAxis?Math.abs(a.x-b.x)>Math.abs(a.y-b.y)?this.addOffset({x:-(a.x-b.x),y:0}):this.addOffset({y:-(a.y-b.y),x:0}):this.addOffset({y:-(a.y-b.y),x:-(a.x-b.x)}))},rotate:function(a,b){},getRotateAngle:function(a){if(a.length>1){var b=a[1].x-a[0].x,c=a[1].y-a[0].y;return b?Math.atan(c/b):0}},getTouchCenter:function(a){return this.getVectorAvg(a)},getVectorAvg:function(a){return{x:a.map(function(a){return a.x}).reduce(c)/a.length,y:a.map(function(a){return a.y}).reduce(c)/a.length}},addOffset:function(a){this.offset={x:this.offset.x+a.x,y:this.offset.y+a.y}},sanitize:function(){this.zoomFactor<this.options.zoomOutFactor?this.zoomOutAnimation():this.isInsaneOffset(this.offset)&&this.sanitizeOffsetAnimation()},isInsaneOffset:function(a){var b=this.sanitizeOffset(a);return b.x!==a.x||b.y!==a.y},sanitizeOffsetAnimation:function(){var a=this.sanitizeOffset(this.offset),b={x:this.offset.x,y:this.offset.y},c=function(c){this.offset.x=b.x+c*(a.x-b.x),this.offset.y=b.y+c*(a.y-b.y),this.update()}.bind(this);this.animate(this.options.animationDuration,this.options.animationInterval,c,this.swing)},zoomOutAnimation:function(){var a=this.zoomFactor,b=1,c=this.getCurrentZoomCenter(),d=function(d){this.scaleTo(a+d*(b-a),c)}.bind(this);this.animate(this.options.animationDuration,this.options.animationInterval,d,this.swing)},updateAspectRatio:function(){this.setContainerY(this.getContainerX()/this.getAspectRatio())},getInitialZoomFactor:function(){return this.container[0].offsetWidth/this.el[0].offsetWidth},getAspectRatio:function(){return this.el[0].offsetWidth/this.el[0].offsetHeight},getCurrentZoomCenter:function(){var a=this.container[0].offsetWidth*this.zoomFactor,b=this.offset.x,c=a-b-this.container[0].offsetWidth,d=b/c,e=d*this.container[0].offsetWidth/(d+1),f=this.container[0].offsetHeight*this.zoomFactor,g=this.offset.y,h=f-g-this.container[0].offsetHeight,i=g/h,j=i*this.container[0].offsetHeight/(i+1);return 0===c&&(e=this.container[0].offsetWidth),0===h&&(j=this.container[0].offsetHeight),{x:e,y:j}},canDrag:function(){return!d(this.zoomFactor,1)},getTouches:function(a){var b=this.container.offset();return Array.prototype.slice.call(a.touches).map(function(a){return{x:a.pageX-b.left,y:a.pageY-b.top}})},animate:function(a,b,c,d,e){var f=(new Date).getTime(),g=function(){if(this.inAnimation){var h=(new Date).getTime()-f,i=h/a;h>=a?(c(1),e&&e(),this.update(),this.stopAnimation(),this.update()):(d&&(i=d(i)),c(i),this.update(),setTimeout(g,b))}}.bind(this);this.inAnimation=!0,g()},stopAnimation:function(){this.inAnimation=!1},swing:function(a){return-Math.cos(a*Math.PI)/2+.5},getContainerX:function(){return this.container[0].offsetWidth},getContainerY:function(){return this.container[0].offsetHeight},setContainerY:function(a){return this.container.height(a)},setupMarkup:function(){this.container=a('<div class="pic-zoom-container"></div>'),this.el.before(this.container),this.container.append(this.el),this.container.css({overflow:"hidden",position:"relative"}),this.el.css({"-webkit-transform-origin":"0% 0%","-moz-transform-origin":"0% 0%","-ms-transform-origin":"0% 0%","-o-transform-origin":"0% 0%","transform-origin":"0% 0%",position:"absolute"})},end:function(){this.hasInteraction=!1,this.sanitize(),this.update()},bindEvents:function(){e(this.container.get(0),this),a(window).on("resize",this.update.bind(this)),a(this.el).find("img").on("load",this.update.bind(this))},update:function(){this.updatePlaned||(this.updatePlaned=!0,setTimeout(function(){this.updatePlaned=!1,this.updateAspectRatio();var a=this.getInitialZoomFactor()*this.zoomFactor,b=-this.offset.x/a,c=-this.offset.y/a,d="rotate("+this.rotateAngle+"rad) scale3d("+a+", "+a+",1) translate3d("+b+"px,"+c+"px,0px)",e="rotate("+this.rotateAngle+"rad) scale("+a+", "+a+") translate("+b+"px,"+c+"px)",f=function(){this.clone&&(this.clone.remove(),delete this.clone)}.bind(this);this.el.css({"-webkit-transform-origin":"50% 50%","-moz-transform-origin":"50% 50%","-ms-transform-origin":"50% 50%","-o-transform-origin":"50% 50%","transform-origin":"50% 50%"}),!this.options.use2d||this.hasInteraction||this.inAnimation?(this.is3d=!0,f(),this.el.css({"-webkit-transform":d,"-o-transform":e,"-ms-transform":e,"-moz-transform":e,transform:d})):(this.is3d&&(this.clone=this.el.clone(),this.clone.css("pointer-events","none"),this.clone.appendTo(this.container),setTimeout(f,200)),this.el.css({"-webkit-transform":e,"-o-transform":e,"-ms-transform":e,"-moz-transform":e,transform:e}),this.is3d=!1)}.bind(this),0))},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1}};var e=function(a,b){var c=null,d=0,e=null,f=function(a,d){if(c!==a){if(c&&!a)switch(c){case"zoom":b.handleZoomEnd(d);break;case"drag":b.handleDragEnd(d)}switch(a){case"zoom":b.handleZoomStart(d);break;case"drag":b.handleDragStart(d)}}c=a},g=function(a){2===d?f("zoom"):1===d&&b.canDrag()?f("drag",a):f(null,a)},h=function(a){return Array.prototype.slice.call(a).map(function(a){return{x:a.pageX,y:a.pageY}})},i=function(a,b){var c,d;return c=a.x-b.x,d=a.y-b.y,Math.sqrt(c*c+d*d)},j=function(a,b){var c=i(a[0],a[1]),d=i(b[0],b[1]);return d/c},k=function(a){a.stopPropagation(),a.preventDefault()},l=!0;a.addEventListener("touchstart",function(a){b.enabled&&(l=!0,d=a.touches.length)}),a.addEventListener("touchmove",function(a){if(b.enabled){if(l){if(g(a),c){switch(c){case"zoom":b.handleFirstZoom(a)}k(a)}e=h(a.touches)}else{switch(c){case"zoom":b.handleZoom(a,j(e,h(a.touches)));break;case"drag":b.handleDrag(a)}c&&(k(a),b.update())}l=!1}}),a.addEventListener("touchend",function(a){b.enabled&&(b.lastAngle=b.rotateAngle,d=a.touches.length,g(a))})};return b};"undefined"!=typeof define&&define.amd?define(["zepto"],function(b){return a(b)}):window.PicZoom=a(window.$)}).call(this),function(){var a={init:function(){this.load()},load:function(){return this.x=[],this.y=[],this.clickDrag=[],this.lock=!1,this.isEraser=!1,this.storageColor="#000000",this.eraserRadius=15,this.color=["#000000","#FF0000","#80FF00","#00FFFF","#808080","#FF8000","#408080","#8000FF","#CCCC00"],this.fontWeight=[2,5,8],this.$=function(a){return"string"==typeof a?document.getElementById(a):a},this.canvas=this.$("canvas"),this.canvas.getContext?(this.cxt=this.canvas.getContext("2d"),this.cxt.lineJoin="round",this.cxt.lineWidth=5,this.iptClear=this.$("clear"),this.revocation=this.$("revocation"),this.imgurl=this.$("imgurl"),this.w=this.canvas.width,this.h=this.canvas.height,this.touch="createTouch"in document,this.StartEvent=this.touch?"touchstart":"mousedown",this.MoveEvent=this.touch?"touchmove":"mousemove",this.EndEvent=this.touch?"touchend":"mouseup",void this.bind()):void alert("您的浏览器不支持 canvas 标签")},bind:function(){var a=this;this.iptClear.onclick=function(){a.clear()},this.canvas["on"+a.StartEvent]=function(b){var c=a.touch?b.touches[0]:b,d=c.clientX-c.target.offsetLeft,e=c.clientY-c.target.offsetTop+$("body").scrollTop();a.isEraser?a.resetEraser(d,e,c):(a.movePoint(d,e),a.drawPoint()),a.lock=!0,b.stopPropagation(),b.preventDefault()},this.canvas["on"+a.MoveEvent]=function(b){var c=a.touch?b.touches[0]:b;if(a.lock){var d=c.clientX-c.target.offsetLeft,e=c.clientY-c.target.offsetTop+$("body").scrollTop();a.isEraser?a.resetEraser(d,e,c):(a.movePoint(d,e,!0),a.drawPoint())}b.stopPropagation(),b.preventDefault()},this.canvas["on"+a.EndEvent]=function(b){a.lock=!1,a.x=[],a.y=[],a.clickDrag=[],clearInterval(a.Timer),a.Timer=null,b.stopPropagation(),b.preventDefault()},this.revocation.onclick=function(){a.redraw()},this.changeColor(),this.imgurl.onclick=function(){a.getUrl()},this.$("eraser").onclick=function(b){a.isEraser=!0,a.$("error").style.color="red",a.$("error").innerHTML="您已使用橡皮擦！"}},movePoint:function(a,b,c){this.x.push(a),this.y.push(b),this.clickDrag.push(b)},drawPoint:function(a,b,c){for(var d=0;d<this.x.length;d++)this.cxt.beginPath(),this.clickDrag[d]&&d?this.cxt.moveTo(this.x[d-1],this.y[d-1]):this.cxt.moveTo(this.x[d]-1,this.y[d]),this.cxt.lineTo(this.x[d],this.y[d]),this.cxt.closePath(),this.cxt.stroke()},clear:function(){this.cxt.clearRect(0,0,this.w,this.h)},redraw:function(){this.cxt.restore()},preventDefault:function(a){var b=this.touch?a.touches[0]:a;this.touch?b.preventDefault():window.event.returnValue=!1},changeColor:function(){for(var a=this,b=this.$("color").getElementsByTagName("input"),c=this.$("font").getElementsByTagName("input"),d=0,e=b.length;e>d;d++)b[d].index=d,b[d].onclick=function(){a.cxt.save(),a.cxt.strokeStyle=a.color[this.index],a.storageColor=a.color[this.index],a.$("error").style.color="#000",a.$("error").innerHTML="如果有错误，请使用橡皮擦：",a.cxt.strokeStyle=a.storageColor,a.isEraser=!1};for(var d=0,e=c.length;e>d;d++)a.cxt.save(),c[d].index=d,c[d].onclick=function(){a.changeBackground(this.index),a.cxt.lineWidth=a.fontWeight[this.index],a.$("error").style.color="#000",a.$("error").innerHTML="如果有错误，请使用橡皮擦：",a.isEraser=!1,a.cxt.strokeStyle=a.storageColor}},changeBackground:function(a){for(var b=this.$("font").getElementsByTagName("input"),c=0,d=b.length;d>c;c++)b[c].className="",c==a&&(b[c].className="grea")},getUrl:function(){this.$("html").innerHTML=this.canvas.toDataURL()},resetEraser:function(a,b,c){var d=this;d.cxt.globalCompositeOperation="destination-out",d.cxt.beginPath(),d.cxt.arc(a,b,d.eraserRadius,0,2*Math.PI),d.cxt.strokeStyle="rgba(250,250,250,0)",d.cxt.fill(),d.cxt.globalCompositeOperation="source-over"}};window.paint=a}.call(this);